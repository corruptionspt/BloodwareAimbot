local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")
local LocalPlayer = Players.LocalPlayer
local plr = LocalPlayer
local Net = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net")
local UseItem = Net:WaitForChild("RE/UseItem")
local QuantumEvent = Net:WaitForChild("RE/QuantumCloner/OnTeleport")

local generationHighlights = {}
local espLockHighlights = {}
local xrayparts = {}
local tracers = {}
local maxPlotSign = nil
local maxSpawnPart = nil
local maxAnimalOverhead = nil
local maxDeliveryHitbox = nil
local maxPurchases = nil
local basePos = nil
local lastFlyAttempt = 0
local FLY_COOLDOWN = 3

local function parseValue(text)
    text = text:gsub("/s", "")
    local num = tonumber(text:match("(%d+%.?%d*)")) or 0
    local suffix = text:match("%d+%.?%d*(%a+)") or ""
    suffix = suffix:lower()
    if suffix == "k" then num = num * 1e3 end
    if suffix == "m" then num = num * 1e6 end
    if suffix == "b" then num = num * 1e9 end
    return num
end

local function setBaseToDeliveryHitbox()
    local plots = Workspace:FindFirstChild("Plots")
    if plots then
        for _, plot in ipairs(plots:GetChildren()) do
            local plotSign = plot:FindFirstChild("PlotSign")
            if plotSign then
                local surfaceGui = plotSign:FindFirstChild("SurfaceGui")
                if surfaceGui then
                    local frame = surfaceGui:FindFirstChild("Frame")
                    if frame then
                        local textLabel = frame:FindFirstChild("TextLabel")
                        if textLabel and textLabel.Text == LocalPlayer.DisplayName .. "'s Base" then
                            local deliveryHitbox = plot:FindFirstChild("DeliveryHitbox")
                            if deliveryHitbox and deliveryHitbox:IsA("BasePart") then
                                basePos = deliveryHitbox.Position
                                return
                            end
                        end
                    end
                end
            end
        end
    end
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        basePos = LocalPlayer.Character.HumanoidRootPart.Position + LocalPlayer.Character.HumanoidRootPart.CFrame.LookVector * 2
    end
end

local function clearTracers()
    for _, tracer in ipairs(tracers) do
        if tracer and tracer.Parent then
            tracer:Destroy()
        end
    end
    tracers = {}
end

local function createTracer(targetPos, color)
    local camera = Workspace.CurrentCamera
    local tracer = Instance.new("Beam")
    tracer.Color = ColorSequence.new(color)
    tracer.Transparency = NumberSequence.new(0.2)
    tracer.Width0 = 8
    tracer.Width1 = 8
    tracer.FaceCamera = true
    tracer.Parent = camera
    local att0 = Instance.new("Attachment")
    att0.Position = Vector3.new(0, 0, 0)
    att0.Parent = camera
    local att1 = Instance.new("Attachment")
    att1.WorldPosition = targetPos
    att1.Parent = camera
    tracer.Attachment0 = att0
    tracer.Attachment1 = att1
    table.insert(tracers, tracer)
end

local function antiAnchor()
    local char = LocalPlayer.Character
    if not char then return end
    for _, part in ipairs(char:GetDescendants()) do
        if part:IsA("BasePart") and part.Anchored then
            part.Anchored = false
        end
    end
end

local function antibee()
    local LOCKED_FOV = Workspace.CurrentCamera.FieldOfView
    local function getInputVector()
        local vec = Vector3.new()
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then vec = vec + Vector3.new(0,0,-1) end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then vec = vec + Vector3.new(0,0,1) end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then vec = vec + Vector3.new(-1,0,0) end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then vec = vec + Vector3.new(1,0,0) end
        return vec
    end
    local function getCameraRelativeVector(inputVec)
        if inputVec.Magnitude == 0 then return Vector3.new() end
        local camCF = Workspace.CurrentCamera.CFrame
        local camLook = Vector3.new(camCF.LookVector.X, 0, camCF.LookVector.Z).Unit
        local camRight = camCF.RightVector
        local move = (camLook * -inputVec.Z) + (camRight * inputVec.X)
        return move.Unit
    end
    task.spawn(function()
        while true do
            local char = LocalPlayer.Character
            if char then
                local humanoid = char:FindFirstChildOfClass("Humanoid")
                local hrp = char:FindFirstChild("HumanoidRootPart")
                if humanoid and hrp then
                    if Workspace.CurrentCamera.FieldOfView ~= LOCKED_FOV then
                        Workspace.CurrentCamera.FieldOfView = LOCKED_FOV
                    end
                    local inputVec = getInputVector()
                    if inputVec.Magnitude > 0 then
                        local moveDir = getCameraRelativeVector(inputVec)
                        local yVel = hrp.Velocity.Y
                        hrp.Velocity = moveDir * humanoid.WalkSpeed + Vector3.new(0, yVel, 0)
                    end
                end
            end
            task.wait(0.1)
        end
    end)
end

local function handleAntiExploit(char)
    task.wait(1)
    pcall(function()
        if char:GetAttribute("AntiExploitLoaded") ~= nil then
            char:SetAttribute("AntiExploitLoaded", false)
            char:SetAttribute("AntiExploitLoaded", nil)
        end
    end)
    local playerModel = Workspace:FindFirstChild(plr.Name)
    if playerModel then
        pcall(function()
            local attr = playerModel:FindFirstChild("AntiExploitLoaded")
            if attr then
                if attr:IsA("BoolValue") then attr.Value = false end
                attr:Destroy()
            end
        end)
    end
end

local function antiafk()
    if getconnections then
        for _, connection in pairs(getconnections(LocalPlayer.Idled)) do
            if connection["Disable"] then
                connection["Disable"](connection)
            elseif connection["Disconnect"] then
                connection["Disconnect"](connection)
            end
        end
    else
        LocalPlayer.Idled:Connect(function()
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new())
        end)
    end
end

local function autoload()
    TeleportService.TeleportInitFailed:Connect(function(player, teleportResult, errorMessage)
        loadstring(game:HttpGet("YOUR_RAW_GITHUB_LINK_HERE"))()
    end)
    LocalPlayer.CharacterAdded:Connect(function()
        task.wait(3)
        loadstring(game:HttpGet("YOUR_RAW_GITHUB_LINK_HERE"))()
    end)
end

function highestesp()
    for _, v in ipairs(generationHighlights) do if v and v.Parent then v:Destroy() end end
    generationHighlights = {}
    local maxValue = -math.huge
    local newMaxPlotSign = nil
    local newMaxSpawnPart = nil
    local newMaxAnimalOverhead = nil
    local newMaxDeliveryHitbox = nil
    local newMaxPurchases = nil
    local plots = Workspace:FindFirstChild("Plots")
    if plots then
        for _, plot in ipairs(plots:GetChildren()) do
            local plotSign = plot:FindFirstChild("PlotSign")
            local isLocalBase = false
            if plotSign then
                local surfaceGui = plotSign:FindFirstChild("SurfaceGui")
                if surfaceGui then
                    local frame = surfaceGui:FindFirstChild("Frame")
                    if frame then
                        local textLabel = frame:FindFirstChild("TextLabel")
                        if textLabel and textLabel.Text == LocalPlayer.DisplayName .. "'s Base" then
                            isLocalBase = true
                        end
                    end
                end
            end
            if isLocalBase then continue end
            local animalPodiums = plot:FindFirstChild("AnimalPodiums")
            if animalPodiums then
                for _, podium in ipairs(animalPodiums:GetChildren()) do
                    local base = podium:FindFirstChild("Base")
                    if base then
                        local spawn = base:FindFirstChild("Spawn")
                        if spawn and spawn:IsA("BasePart") then
                            local attachment = spawn:FindFirstChild("Attachment")
                            if attachment then
                                local animalOverhead = attachment:FindFirstChild("AnimalOverhead")
                                if animalOverhead then
                                    local generation = animalOverhead:FindFirstChild("Generation")
                                    if generation and generation:IsA("TextLabel") then
                                        local value = parseValue(generation.Text)
                                        if value > maxValue then
                                            maxValue = value
                                            newMaxPlotSign = plot:FindFirstChild("PlotSign")
                                            newMaxSpawnPart = spawn
                                            newMaxAnimalOverhead = animalOverhead
                                            newMaxDeliveryHitbox = plot:FindFirstChild("DeliveryHitbox")
                                            newMaxPurchases = plot:FindFirstChild("Purchases")
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    maxPlotSign = newMaxPlotSign
    maxSpawnPart = newMaxSpawnPart
    maxAnimalOverhead = newMaxAnimalOverhead
    maxDeliveryHitbox = newMaxDeliveryHitbox
    maxPurchases = newMaxPurchases
    if maxPlotSign and maxSpawnPart and maxAnimalOverhead then
        local spawnHighlight = Instance.new("Highlight")
        spawnHighlight.Parent = maxSpawnPart
        spawnHighlight.FillTransparency = 0.3
        spawnHighlight.FillColor = Color3.fromRGB(0, 100, 255)
        spawnHighlight.OutlineTransparency = 0
        spawnHighlight.OutlineColor = Color3.fromRGB(0, 200, 255)
        table.insert(generationHighlights, spawnHighlight)
        local model = maxSpawnPart.Parent.Parent.Parent
        if model and model:FindFirstChild("Humanoid") then
            local modelHighlight = Instance.new("Highlight")
            modelHighlight.Parent = model
            modelHighlight.FillTransparency = 0.3
            modelHighlight.FillColor = Color3.fromRGB(0, 255, 0)
            modelHighlight.OutlineTransparency = 0
            modelHighlight.OutlineColor = Color3.fromRGB(255, 255, 0)
            table.insert(generationHighlights, modelHighlight)
        end
        local displayName = maxAnimalOverhead:FindFirstChild("DisplayName")
        if displayName then
            local nameGui = Instance.new("BillboardGui")
            nameGui.Size = UDim2.new(0, 180, 0, 50)
            nameGui.StudsOffset = Vector3.new(0, 6, 0)
            nameGui.Adornee = maxSpawnPart
            nameGui.AlwaysOnTop = true
            nameGui.Parent = maxSpawnPart
            local nameText = Instance.new("TextLabel")
            nameText.Parent = nameGui
            nameText.Size = UDim2.new(1, 0, 1, 0)
            nameText.BackgroundTransparency = 1
            nameText.Text = displayName.Text
            nameText.TextColor3 = Color3.fromRGB(255, 255, 0)
            nameText.Font = Enum.Font.Arcade
            nameText.TextSize = 32
            nameText.TextStrokeTransparency = 0
            nameText.TextStrokeColor3 = Color3.new(0, 0, 0)
            table.insert(generationHighlights, nameGui)
        end
        local genLabel = maxAnimalOverhead:FindFirstChild("Generation")
        if genLabel then
            local genGui = Instance.new("BillboardGui")
            genGui.Size = UDim2.new(0, 180, 0, 50)
            genGui.StudsOffset = Vector3.new(0, 12, 0)
            genGui.Adornee = maxSpawnPart
            genGui.AlwaysOnTop = true
            genGui.Parent = maxSpawnPart
            local genText = Instance.new("TextLabel")
            genText.Parent = genGui
            genText.Size = UDim2.new(1, 0, 1, 0)
            genText.BackgroundTransparency = 1
            genText.Text = genLabel.Text
            genText.TextColor3 = Color3.fromRGB(0, 255, 0)
            genText.Font = Enum.Font.Arcade
            genText.TextSize = 32
            genText.TextStrokeTransparency = 0
            genText.TextStrokeColor3 = Color3.new(0, 0, 0)
            table.insert(generationHighlights, genGui)
        end
    end
end

function lockesp()
    for _, v in ipairs(espLockHighlights) do if v and v.Parent then v:Destroy() end end
    espLockHighlights = {}
    local plots = Workspace:FindFirstChild("Plots")
    if plots then
        for _, plot in ipairs(plots:GetChildren()) do
            local purchases = plot:FindFirstChild("Purchases")
            if purchases and #purchases:GetChildren() >= 2 then
                local purchase = purchases:GetChildren()[2]
                local main = purchase:FindFirstChild("Main")
                if main then
                    local billboard = main:FindFirstChild("BillboardGui")
                    if billboard then
                        local remainingTime = billboard:FindFirstChild("RemainingTime")
                        if remainingTime and remainingTime:IsA("TextLabel") then
                            local espGui = Instance.new("BillboardGui")
                            espGui.Size = UDim2.new(0, 180, 0, 60)
                            espGui.StudsOffset = Vector3.new(0, 6, 0)
                            espGui.Adornee = main
                            espGui.AlwaysOnTop = true
                            espGui.Parent = main
                            local espText = Instance.new("TextLabel")
                            espText.Parent = espGui
                            espText.Size = UDim2.new(1, 0, 1, 0)
                            espText.BackgroundTransparency = 1
                            espText.Text = remainingTime.Text
                            espText.TextColor3 = Color3.new(1, 1, 1)
                            espText.Font = Enum.Font.Arcade
                            espText.TextSize = 36
                            espText.TextStrokeTransparency = 0
                            espText.TextStrokeColor3 = Color3.new(0, 0, 0)
                            table.insert(espLockHighlights, espGui)
                        end
                    end
                end
            end
        end
    end
end

function xraybase()
    local plots = Workspace:FindFirstChild("Plots")
    if plots then
        for _, plot in ipairs(plots:GetChildren()) do
            if plot:IsA("Model") then
                for _, part in ipairs(plot:GetDescendants()) do
                    if part:IsA("BasePart") and part.Transparency < 0.7 then
                        part.Transparency = 0.7
                        table.insert(xrayparts, part)
                    end
                end
            end
        end
    end
end

function resetxray()
    for _, part in ipairs(xrayparts) do
        if part and part.Parent then
            part.Transparency = 0
        end
    end
    xrayparts = {}
end

function destroysentry()
    for _, obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("BasePart") and obj.Name:match("^sentry_") then
            UseItem:FireServer()
            task.wait(0.1)
            local mouse = LocalPlayer:GetMouse()
            mouse.Button1Down:Fire()
            task.wait(0.1)
            mouse.Button1Up:Fire()
            obj:Destroy()
        end
    end
end

function antitrap()
    task.spawn(function()
        while true do
            antiAnchor()
            task.wait(0.1)
        end
    end)
end

function getjobid()
    return game.JobId
end

function joinjob(id)
    if id and id ~= "" then
        TeleportService:TeleportToPlaceInstance(game.PlaceId, id, LocalPlayer)
    end
end

function copyjobid()
    setclipboard(game.JobId)
end

function tophighest()
    local currentTime = tick()
    if currentTime - lastFlyAttempt < FLY_COOLDOWN then return end
    lastFlyAttempt = currentTime
    if maxSpawnPart then
        LocalPlayer.Character:BreakJoints()
        task.wait(0.5)
        UseItem:FireServer()
    end
    LocalPlayer.CharacterAdded:Wait()
    task.wait(1)
    QuantumEvent:FireServer()
end

function DisableAntiExploit()
    local char = LocalPlayer.Character
    if char then
        handleAntiExploit(char)
    end
    LocalPlayer.CharacterAdded:Connect(handleAntiExploit)
end

return {
    highestesp = highestesp,
    lockesp = lockesp,
    xraybase = xraybase,
    resetxray = resetxray,
    destroysentry = destroysentry,
    getjobid = getjobid,
    joinjob = joinjob,
    copyjobid = copyjobid,
    antibee = antibee,
    tophighest = tophighest,
    setBaseToDeliveryHitbox = setBaseToDeliveryHitbox,
    antitrap = antitrap,
    antiafk = antiafk,
    autoload = autoload,
    DisableAntiExploit = DisableAntiExploit
}
